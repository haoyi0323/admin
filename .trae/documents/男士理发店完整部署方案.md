# 男士理发店完整部署方案

## 1. 项目架构概述

### 1.1 当前技术栈
- **前端客户端**: uni-app (Vue 2/3) - 支持多端发布
- **管理后台**: uni-admin (Vue 3 + Vite) - Web管理界面
- **后端服务**: uniCloud阿里云版 - 云函数 + 云数据库
- **认证系统**: uni-id-co + 自定义权限管理
- **数据存储**: 云数据库 + 本地localStorage模拟

### 1.2 部署目标
1. 管理后台通过自定义域名访问
2. 前端客户端连接到云服务
3. 实现前后端数据实时同步
4. 支持网页登录管理

## 2. 阿里云服务器部署方案

### 2.1 服务器环境准备

#### 2.1.1 ECS服务器配置
```bash
# 1. 更新系统
sudo yum update -y

# 2. 安装Node.js 18+
curl -fsSL https://rpm.nodesource.com/setup_18.x | sudo bash -
sudo yum install -y nodejs

# 3. 安装Nginx
sudo yum install -y nginx

# 4. 安装PM2进程管理器
sudo npm install -g pm2

# 5. 创建项目目录
sudo mkdir -p /var/www/barbershop
sudo chown -R $USER:$USER /var/www/barbershop
```

#### 2.1.2 项目构建和上传
```bash
# 本地构建管理后台
cd 男士理发店管理后台
npm install
npm run build:h5

# 上传构建文件到服务器
scp -r dist/* user@your-server-ip:/var/www/barbershop/admin/

# 构建客户端H5版本
cd ../男士理发店客户端
npm install
npm run build:h5

# 上传客户端文件
scp -r unpackage/dist/build/h5/* user@your-server-ip:/var/www/barbershop/client/
```

### 2.2 Nginx配置

#### 2.2.1 创建Nginx配置文件
```nginx
# /etc/nginx/conf.d/barbershop.conf
server {
    listen 80;
    server_name yourdomain.com www.yourdomain.com;
    
    # 重定向到HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name yourdomain.com www.yourdomain.com;
    
    # SSL证书配置
    ssl_certificate /etc/nginx/ssl/yourdomain.com.pem;
    ssl_certificate_key /etc/nginx/ssl/yourdomain.com.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;
    ssl_prefer_server_ciphers on;
    
    # 管理后台路由
    location /admin {
        alias /var/www/barbershop/admin;
        try_files $uri $uri/ /admin/index.html;
        
        # 设置缓存
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }
    
    # 客户端路由
    location / {
        root /var/www/barbershop/client;
        try_files $uri $uri/ /index.html;
        
        # 设置缓存
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }
    
    # API代理（如果需要）
    location /api/ {
        proxy_pass https://your-unicloud-api-domain/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # 安全头设置
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
    add_header Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'" always;
}
```

#### 2.2.2 启动Nginx
```bash
# 测试配置
sudo nginx -t

# 启动Nginx
sudo systemctl start nginx
sudo systemctl enable nginx

# 重载配置
sudo systemctl reload nginx
```

## 3. uniCloud云服务配置

### 3.1 云函数部署

#### 3.1.1 配置uniCloud
```javascript
// 在HBuilderX中配置uniCloud
// 1. 右键uniCloud-aliyun目录
// 2. 选择"关联云服务空间"
// 3. 创建或选择已有的阿里云服务空间
```

#### 3.1.2 部署云函数
```bash
# 在HBuilderX中
# 1. 右键cloudfunctions目录
# 2. 选择"上传所有云函数"
# 3. 等待部署完成
```

#### 3.1.3 配置云数据库
```javascript
// 在uniCloud控制台中
// 1. 进入云数据库管理
// 2. 导入database目录下的schema文件
// 3. 初始化数据表
```

### 3.2 数据同步配置

#### 3.2.1 创建数据同步云函数
```javascript
// cloudfunctions/data-sync/index.js
const db = uniCloud.database()

exports.main = async (event, context) => {
  const { action, collection, data } = event
  
  try {
    switch (action) {
      case 'create':
        return await db.collection(collection).add(data)
      case 'update':
        return await db.collection(collection).doc(data._id).update(data)
      case 'delete':
        return await db.collection(collection).doc(data._id).remove()
      case 'query':
        return await db.collection(collection).get()
      default:
        throw new Error('Invalid action')
    }
  } catch (error) {
    return {
      code: -1,
      message: error.message
    }
  }
}
```

#### 3.2.2 前端数据同步适配
```javascript
// utils/dataStore.js 修改
class DataStore {
  constructor() {
    this.isCloud = true // 启用云端模式
  }
  
  async syncToCloud(collection, action, data) {
    if (!this.isCloud) return
    
    try {
      const result = await uniCloud.callFunction({
        name: 'data-sync',
        data: {
          action,
          collection,
          data
        }
      })
      return result
    } catch (error) {
      console.error('云端同步失败:', error)
      throw error
    }
  }
  
  async createBooking(booking) {
    // 本地存储
    const result = this.addBooking(booking)
    
    // 同步到云端
    await this.syncToCloud('bookings', 'create', booking)
    
    return result
  }
  
  async updateBooking(id, updates) {
    // 本地更新
    const result = this.updateBooking(id, updates)
    
    // 同步到云端
    await this.syncToCloud('bookings', 'update', { _id: id, ...updates })
    
    return result
  }
}
```

## 4. 域名配置

### 4.1 域名解析设置

#### 4.1.1 在阿里云域名控制台添加解析记录
```
记录类型: A
主机记录: @
解析线路: 默认
记录值: 你的ECS服务器公网IP
TTL: 600

记录类型: A
主机记录: www
解析线路: 默认
记录值: 你的ECS服务器公网IP
TTL: 600

记录类型: CNAME
主机记录: admin
解析线路: 默认
记录值: yourdomain.com
TTL: 600
```

### 4.2 SSL证书配置

#### 4.2.1 申请免费SSL证书
```bash
# 安装certbot
sudo yum install -y certbot python3-certbot-nginx

# 申请证书
sudo certbot --nginx -d yourdomain.com -d www.yourdomain.com

# 设置自动续期
sudo crontab -e
# 添加以下行
0 12 * * * /usr/bin/certbot renew --quiet
```

## 5. 前后端数据同步方案

### 5.1 实时数据同步

#### 5.1.1 WebSocket连接配置
```javascript
// utils/websocket.js
class WebSocketManager {
  constructor() {
    this.ws = null
    this.reconnectAttempts = 0
    this.maxReconnectAttempts = 5
  }
  
  connect() {
    this.ws = new WebSocket('wss://yourdomain.com/ws')
    
    this.ws.onopen = () => {
      console.log('WebSocket连接已建立')
      this.reconnectAttempts = 0
    }
    
    this.ws.onmessage = (event) => {
      const data = JSON.parse(event.data)
      this.handleMessage(data)
    }
    
    this.ws.onclose = () => {
      console.log('WebSocket连接已关闭')
      this.reconnect()
    }
  }
  
  handleMessage(data) {
    // 处理实时数据更新
    switch (data.type) {
      case 'booking_update':
        this.updateBookingData(data.payload)
        break
      case 'user_update':
        this.updateUserData(data.payload)
        break
    }
  }
  
  reconnect() {
    if (this.reconnectAttempts < this.maxReconnectAttempts) {
      setTimeout(() => {
        this.reconnectAttempts++
        this.connect()
      }, 1000 * Math.pow(2, this.reconnectAttempts))
    }
  }
}
```

### 5.2 数据库同步策略

#### 5.2.1 双向同步机制
```javascript
// 管理后台数据同步
class AdminDataSync {
  async syncBookings() {
    try {
      // 从云端获取最新数据
      const cloudData = await uniCloud.callFunction({
        name: 'data-sync',
        data: {
          action: 'query',
          collection: 'bookings'
        }
      })
      
      // 更新本地数据
      this.updateLocalBookings(cloudData.result.data)
      
      // 触发界面更新
      this.$emit('bookings-updated', cloudData.result.data)
    } catch (error) {
      console.error('同步预约数据失败:', error)
    }
  }
  
  async updateBookingStatus(bookingId, status) {
    try {
      // 更新云端数据
      await uniCloud.callFunction({
        name: 'data-sync',
        data: {
          action: 'update',
          collection: 'bookings',
          data: {
            _id: bookingId,
            status: status,
            updated_at: new Date()
          }
        }
      })
      
      // 通知客户端更新
      this.notifyClients('booking_status_changed', {
        bookingId,
        status
      })
    } catch (error) {
      console.error('更新预约状态失败:', error)
    }
  }
}
```

## 6. 网页登录配置

### 6.1 管理后台登录页面

#### 6.1.1 修改登录组件
```vue
<!-- pages/login/login.vue -->
<template>
  <div class="login-container">
    <div class="login-form">
      <h2>理发店管理后台</h2>
      <uni-forms ref="form" :model="formData" :rules="rules">
        <uni-forms-item name="username">
          <uni-easyinput 
            v-model="formData.username" 
            placeholder="请输入用户名"
            prefixIcon="person"
          />
        </uni-forms-item>
        <uni-forms-item name="password">
          <uni-easyinput 
            v-model="formData.password" 
            type="password"
            placeholder="请输入密码"
            prefixIcon="locked"
          />
        </uni-forms-item>
        <button @click="handleLogin" class="login-btn">
          登录
        </button>
      </uni-forms>
    </div>
  </div>
</template>

<script>
import { AuthUtils } from '@/utils/auth.js'

export default {
  data() {
    return {
      formData: {
        username: '',
        password: ''
      },
      rules: {
        username: {
          rules: [{ required: true, errorMessage: '请输入用户名' }]
        },
        password: {
          rules: [{ required: true, errorMessage: '请输入密码' }]
        }
      }
    }
  },
  methods: {
    async handleLogin() {
      try {
        const result = await this.$refs.form.validate()
        if (result) {
          const loginResult = await AuthUtils.login(
            this.formData.username,
            this.formData.password
          )
          
          if (loginResult.success) {
            uni.showToast({
              title: '登录成功',
              icon: 'success'
            })
            
            // 跳转到管理后台首页
            uni.reLaunch({
              url: '/pages/index/index'
            })
          } else {
            uni.showToast({
              title: loginResult.message || '登录失败',
              icon: 'error'
            })
          }
        }
      } catch (error) {
        console.error('登录失败:', error)
        uni.showToast({
          title: '登录失败',
          icon: 'error'
        })
      }
    }
  }
}
</script>
```

### 6.2 权限验证中间件

#### 6.2.1 路由守卫配置
```javascript
// router/index.js
import { AuthUtils } from '@/utils/auth.js'

const router = {
  beforeEach: async (to, from, next) => {
    // 检查是否需要登录
    if (to.meta && to.meta.requireAuth) {
      const isLoggedIn = await AuthUtils.checkLoginStatus()
      
      if (!isLoggedIn) {
        // 未登录，跳转到登录页
        uni.reLaunch({
          url: '/pages/login/login'
        })
        return
      }
      
      // 检查权限
      if (to.meta.permission) {
        const hasPermission = await AuthUtils.checkPermission(
          to.meta.permission.module,
          to.meta.permission.action
        )
        
        if (!hasPermission) {
          uni.showToast({
            title: '没有访问权限',
            icon: 'error'
          })
          return
        }
      }
    }
    
    next()
  }
}

export default router
```

## 7. 部署步骤总结

### 7.1 部署清单

#### 7.1.1 服务器准备
- [ ] 购买阿里云ECS服务器
- [ ] 配置安全组（开放80、443端口）
- [ ] 安装Node.js、Nginx、PM2
- [ ] 创建项目目录

#### 7.1.2 域名配置
- [ ] 域名实名认证
- [ ] 添加DNS解析记录
- [ ] 申请SSL证书
- [ ] 配置HTTPS

#### 7.1.3 项目部署
- [ ] 构建前端项目
- [ ] 上传文件到服务器
- [ ] 配置Nginx
- [ ] 部署uniCloud云函数
- [ ] 配置数据库

#### 7.1.4 测试验证
- [ ] 访问域名测试
- [ ] 登录功能测试
- [ ] 数据同步测试
- [ ] 权限验证测试

### 7.2 访问地址

部署完成后的访问地址：
- **客户端**: https://yourdomain.com
- **管理后台**: https://yourdomain.com/admin
- **API接口**: 通过uniCloud云函数提供

### 7.3 维护建议

#### 7.3.1 监控配置
```bash
# 安装监控工具
npm install -g pm2
pm2 install pm2-logrotate

# 设置日志轮转
pm2 set pm2-logrotate:max_size 10M
pm2 set pm2-logrotate:retain 30
```

#### 7.3.2 备份策略
```bash
# 数据库备份脚本
#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/backup/barbershop"

# 创建备份目录
mkdir -p $BACKUP_DIR

# 备份网站文件
tar -czf $BACKUP_DIR/website_$DATE.tar.gz /var/www/barbershop

# 保留最近30天的备份
find $BACKUP_DIR -name "website_*.tar.gz" -mtime +30 -delete
```

## 8. 常见问题解决

### 8.1 部署问题

**Q: Nginx启动失败**
A: 检查配置文件语法：`sudo nginx -t`

**Q: SSL证书申请失败**
A: 确保域名已正确解析到服务器IP

**Q: 云函数调用失败**
A: 检查uniCloud服务空间配置和网络连接

### 8.2 数据同步问题

**Q: 前后端数据不一致**
A: 检查数据同步云函数和WebSocket连接

**Q: 登录状态丢失**
A: 检查token存储和过期时间设置

通过以上完整的部署方案，您可以成功将男士理发店管理系统部署到自己的域名和阿里云服务器上，实现前后端数据同步和网页管理功能。